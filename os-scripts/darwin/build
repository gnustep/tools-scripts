#!/usr/bin/env bash
set -euo pipefail

# Darwin build helper for GNUstep
# Usage: build [prefix]

PREFIX_ARG=${1-}

# Default installation roots
ROOT=/
USR_ROOT=${ROOT}/opt
GNUSTEP_ROOT=${USR_ROOT}/GNUstep
if [ -n "$PREFIX_ARG" ]; then
	GNUSTEP_ROOT="$PREFIX_ARG"
fi

export GNUSTEP_CONFIG_FILE=${USR_ROOT}/etc/GNUstep.conf
export GNUSTEP_INSTALL_LD_SO_CONF=no

echo "Installation directory is $GNUSTEP_ROOT"
echo "Building GNUstep for Darwin"

# Prefer clang on macOS unless CC/CXX are provided
: ${CC:=}
: ${CXX:=}
if [ -z "${CC:-}" ]; then
	if command -v clang >/dev/null 2>&1; then
		export CC=clang
	elif command -v gcc >/dev/null 2>&1; then
		export CC=gcc
	else
		echo "No C compiler found (clang or gcc required)." >&2
		exit 1
	fi
fi
if [ -z "${CXX:-}" ]; then
	if command -v clang++ >/dev/null 2>&1; then
		export CXX=clang++
	elif command -v g++ >/dev/null 2>&1; then
		export CXX=g++
	else
		echo "No C++ compiler found (clang++ or g++ required)." >&2
		exit 1
	fi
fi

# Jobs / parallelism
if command -v nproc >/dev/null 2>&1; then
	JOBS=$(nproc)
else
	JOBS=$(sysctl -n hw.ncpu 2>/dev/null || echo 1)
fi

# Ensure PKG_CONFIG_PATH includes our local tree
export PKG_CONFIG_PATH=${USR_ROOT}/local/lib/pkgconfig:${USR_ROOT}/lib/pkgconfig:${PKG_CONFIG_PATH:-}

fail_if_no_dir() {
	if [ ! -d "$1" ]; then
		echo "Directory $1 not found; expected to be in repo root." >&2
		exit 1
	fi
}

echo "Using CC=${CC} CXX=${CXX} JOBS=${JOBS}"

# Build tools-make
echo "======== Build tools-make"
fail_if_no_dir tools-make
cd tools-make
./configure --with-library-combo=apple-gnu-gnu --with-layout=gnustep --prefix="${GNUSTEP_ROOT}"
make install -j"${JOBS}"

# Source the GNUstep environment from the install prefix if present
if [ -f "${GNUSTEP_ROOT}/System/Library/Makefiles/GNUstep.sh" ]; then
	# shellcheck disable=SC1090
	. "${GNUSTEP_ROOT}/System/Library/Makefiles/GNUstep.sh"
else
	echo "Warning: ${GNUSTEP_ROOT}/System/Library/Makefiles/GNUstep.sh not found after installing tools-make." >&2
fi

# Build libs-base
echo "======== Build libs-base"
fail_if_no_dir ../libs-base
cd ../libs-base
export CFLAGS="${CFLAGS-} -I/usr/local/include"
./configure --with-installation-domain=SYSTEM --disable-icu --disable-invocations
make GNUSTEP_INSTALLATION_DOMAIN=SYSTEM debug=yes install -j"${JOBS}"

# Build libs-gui
echo "======== Build libs-gui"
fail_if_no_dir ../libs-gui
cd ../libs-gui
./configure
make GNUSTEP_INSTALLATION_DOMAIN=SYSTEM debug=yes install -j"${JOBS}"

# Build libs-back
echo "======== Build libs-back"
fail_if_no_dir ../libs-back
cd ../libs-back
./configure --enable-graphics=cairo || true
make GNUSTEP_INSTALLATION_DOMAIN=SYSTEM debug=yes install -j"${JOBS}"

echo
echo "Done."

exit 0
